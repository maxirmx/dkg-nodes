@using System.Text
@using Solnet.Wallet
@using Solnet.Wallet.Bip39
@using Solnet.KeyStore
@using MudBlazor

@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject DkgWebNodeService DkgWebNodeService
@inject KeystoreService KeystoreService


<MudText Align="Align.Center" Class="mb-2" Typo=" Typo.h3">Welcome to Dkg Web Node!</MudText>
<MudText Align="Align.Center" Class="mb-2" Typo=" Typo.h5">
    Before you can use it please either <br />
    <MudButton Variant="@(_showCreateSolanaAccountCard ? Variant.Outlined : Variant.Text)" Color="Color.Primary"
               OnClick="ToggleViewToCreate" Disabled="@_isCreatingAccount">create</MudButton> a new Solana account or
    <MudButton Variant="@(_showImportSolanaAccountCard ? Variant.Outlined : Variant.Text)" Color="Color.Primary"
               OnClick="ToggleViewToImport" Disabled="@_isCreatingAccount">import</MudButton> your existing account.
</MudText>
@if (_showCreateSolanaAccountCard)
{
    <MudCard>
        <MudCardContent>
            <MudText Typo="Typo.h5">Create Solana Account</MudText>
            <MudTextField Class="mb-2" @bind-Value="_mnemonic" Label="Mnemonic seed (12 words)" Variant="Variant.Outlined" 
                          Adornment="Adornment.End" OnAdornmentClick="() => GenerateMnemonic()" AdornmentIcon="@RefreshMnemonicIcon"
                          AdornmentAriaLabel="Create new seed" Immediate="false" Disabled="@_isCreatingAccount" />
            <MudTextField Class="mb-2" @bind-Value="_address" Label="Address" ReadOnly="true" Variant="Variant.Outlined" Disabled="@_isCreatingAccount" />
            <MudTextField Class="mb-2" @bind-Value="_passwordCreate" Label="Password" Variant="Variant.Outlined" InputType="@_passwordCreateInput"
                          Adornment="Adornment.End" AdornmentIcon="@_passwordCreateInputIcon" OnAdornmentClick="ButtonShowPasswordCreateClick"
                          AdornmentAriaLabel="Show Password" Disabled="@_isCreatingAccount" />
            <MudPaper Class="d-flex" Elevation="0">
                <MudCheckBox Class="mb-2 mr-2" @bind-Value="_hasSavedMnemonic" Color="Color.Primary" Disabled="@_isCreatingAccount">I have saved my mnemonic seed and password safely</MudCheckBox>
                <MudButton Class="mb-2" Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!IsMnemonicValid() || !_hasSavedMnemonic || _isCreatingAccount)" 
                           OnClick="CreateAccount">Create Account From Seed</MudButton>
                @if (_isCreatingAccount)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
            </MudPaper>
        </MudCardContent>
    </MudCard>
}
@if (_showImportSolanaAccountCard)
{
    <MudCard>
        <MudCardContent>
            <MudText Class="mb-2" Typo=" Typo.h5">Import Solana Account</MudText>
            <input type="file" id="fileInput" style="display:none" @onchange="HandleFileSelected" />
            <MudTextField Class="mb-2" @bind-Value="_keystoreImport" Label="Keystore Data" Variant="Variant.Outlined" Lines="6" AutoGrow
                          Adornment="Adornment.End" OnAdornmentClick="() => ClickFileInput()" AdornmentIcon="@LoadIcon" 
                          AdornmentAriaLabel="Load key store from file"/>
            <MudTextField Class="mb-2" @bind-Value="_passwordImport" Label="Password" Variant="Variant.Outlined" InputType="@_passwordImportInput" 
                          Adornment="Adornment.End" AdornmentIcon="@_passwordImportInputIcon" OnAdornmentClick="ButtonShowPasswordImportClick" 
                          AdornmentAriaLabel="Show Password" /> 
            <MudButton Class="mb-2" Variant="Variant.Filled" Color="Color.Primary" OnClick="ImportKeystore">Import account</MudButton>     
        </MudCardContent>
    </MudCard>
}

@code {
    private bool _showCreateSolanaAccountCard = false;
    private bool _showImportSolanaAccountCard = false;

    private bool _isCreatingAccount = false;

    private string _passwordCreate = "";

    private string _keystoreImport = "";
    private string _passwordImport = "";

    private string _mnemonic = "";
    private string _address = "";
    private bool _hasSavedMnemonic = false;
     
    private ElementReference fileInput;

    private const string LoadIcon = Icons.Material.Filled.Download;
    private const string RefreshMnemonicIcon = Icons.Material.Filled.Refresh;

    private bool _showPasswordCreate = false;
    private bool _showPasswordImport = false;

    private InputType _passwordCreateInput => _showPasswordCreate ? InputType.Text : InputType.Password;
    private InputType _passwordImportInput => _showPasswordImport ? InputType.Text : InputType.Password;

    private string _passwordCreateInputIcon => _showPasswordCreate ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    private string _passwordImportInputIcon => _showPasswordImport ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;

    private void ButtonShowPasswordCreateClick()
    {
        _showPasswordCreate = !_showPasswordCreate;
    }

    private void ButtonShowPasswordImportClick()
    {
        _showPasswordImport = !_showPasswordImport;
    }

    private async void ClickFileInput()
    {
        await JSRuntime.InvokeVoidAsync("triggerFileInputClick", "fileInput");
    }

    private async void CreateAccount()
    {
        _isCreatingAccount = true;
        StateHasChanged();
        var mnemonic = new Mnemonic(_mnemonic);
        var wallet = new Wallet(mnemonic);
        var account = wallet.Account;

        await KeystoreService.Save(_passwordCreate, account.PrivateKey.KeyBytes, account.PublicKey.Key);
        _isCreatingAccount = false;
        StateHasChanged();

        DkgWebNodeService.SetKeys(account.PrivateKey.Key, account.PublicKey.Key);
    }

    private void GenerateAddress()
    {
        string oldAddress = _address;

        var words = _mnemonic.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
        if (words.Length < 12)
        {
            _address = "";
        }
        else
        {
            try
            {
                var wallet = new Wallet(_mnemonic);
                var account = wallet.Account;
                _address = account.PublicKey.Key;
            }
            catch (Exception)
            {
                _address = "";
            }
        }
        if (_address != oldAddress) StateHasChanged();
    }

    private void GenerateMnemonic()
    {
        var mnemonic = new Mnemonic(WordList.English, WordCount.Twelve);
        _mnemonic = mnemonic.ToString();
        var wallet = new Wallet(_mnemonic);
        Account account = wallet.Account;
        _address = account.PublicKey.Key;
    }

    private async Task HandleFileSelected(ChangeEventArgs e)
    {
        var file = e.Value as IBrowserFile;
        if (file != null)
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream().ReadAsync(buffer);
            _keystoreImport = Encoding.UTF8.GetString(buffer);
            StateHasChanged();
        }
    }

    private void ImportKeystore()
    {
        
    }

    private bool IsMnemonicValid()
    { 
       GenerateAddress();
       return _address != "";  
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        GenerateMnemonic();
        GenerateAddress();
    }

    private void ToggleViewToCreate()
    {
        _showCreateSolanaAccountCard = true;
        _showImportSolanaAccountCard = false;
    }
    private void ToggleViewToImport()
    {
        _showCreateSolanaAccountCard = false;
        _showImportSolanaAccountCard = true;
    }
}
